name: Test SVbyEye Pipeline

on:
  push:
    branches: [ main, claude/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-pipeline:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash -l {0}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libfontconfig1-dev \
          libfreetype6-dev \
          libpng-dev \
          libjpeg-dev \
          libxml2-dev \
          libcurl4-openssl-dev \
          libssl-dev \
          libharfbuzz-dev \
          libfribidi-dev

    - name: Setup Miniforge
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-variant: Miniforge3
        miniforge-version: latest
        activate-environment: svbyeye_pipeline
        environment-file: environment.yml
        use-mamba: true
        auto-activate-base: false

    - name: Install SVbyEye
      env:
        GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      run: Rscript install_svbyeye_github.R

    - name: Verify installation
      run: |
        python --version
        R --version
        snakemake --version
        Rscript -e "library(SVbyEye); cat('SVbyEye version:', as.character(packageVersion('SVbyEye')), '\n')"

    - name: Validate config
      run: python -c "import yaml; yaml.safe_load(open('config.yaml')); print('✓ Config valid')"

    - name: Create test data
      run: python scripts/create_test_data.py

    - name: Dry run pipeline
      run: snakemake --dry-run --cores 1

    - name: Run full pipeline
      run: snakemake --cores 2

    - name: Verify outputs
      run: |
        echo "=== Pipeline Outputs ==="
        ls -lh results/sd_table.tsv
        ls -lh results/alignment_manifest.tsv
        ls -lh results/plots/
        ls -lh results/summary_report.html
        echo "✓ All expected files created"

    - name: Check plot generation
      run: |
        PLOT_COUNT=$(ls results/plots/*.png 2>/dev/null | wc -l)
        echo "Plots generated: $PLOT_COUNT"
        test "$PLOT_COUNT" -gt 0 || exit 1
        echo "✓ Plot generation successful"

    - name: Display summary
      if: always()
      run: test -f results/sd_summary.txt && cat results/sd_summary.txt || echo "No summary file"

    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pipeline-results
        path: results/
        retention-days: 7

    - name: Check for errors in logs
      if: always()
      run: |
        if [ -d "results/logs" ]; then
          if grep -qi error results/logs/*.log 2>/dev/null; then
            echo "✗ Errors found in logs"
            exit 1
          fi
          echo "✓ No errors in logs"
        fi
