name: Test SVbyEye Pipeline

on:
  push:
    branches: [ main, claude/* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  test-pipeline:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Miniforge
      uses: conda-incubator/setup-miniconda@v3
      with:
        miniforge-variant: Miniforge3
        miniforge-version: latest
        activate-environment: pipeline
        use-mamba: true

    - name: Install dependencies with conda
      shell: bash -el {0}
      run: |
        mamba install -y -c conda-forge -c bioconda \
          python=3.9 \
          snakemake=7.* \
          "pulp<2.8" \
          minimap2 \
          samtools \
          pandas \
          pyyaml \
          pysam

    - name: Set up R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.0'

    - name: Install R dependencies
      run: |
        Rscript -e 'install.packages("BiocManager", repos="https://cloud.r-project.org")'
        Rscript -e 'BiocManager::install(c("GenomicRanges", "IRanges", "Biostrings", "GenomeInfoDb"))'
        Rscript -e 'install.packages("ggplot2", repos="https://cloud.r-project.org")'
        Rscript -e 'install.packages("devtools", repos="https://cloud.r-project.org")'

    - name: Install SVbyEye
      run: |
        Rscript -e '
        library(devtools)
        install_github("daewoooo/SVbyEye", branch="master")
        '

    - name: Verify SVbyEye installation
      run: |
        Rscript -e '
        library(SVbyEye)
        cat("✓ SVbyEye version:", as.character(packageVersion("SVbyEye")), "\n")
        '

    - name: Verify tools are installed
      shell: bash -el {0}
      run: |
        echo "=== Checking Python ==="
        python3 --version

        echo "=== Checking R ==="
        R --version | head -n 1

        echo "=== Checking minimap2 ==="
        minimap2 --version

        echo "=== Checking samtools ==="
        samtools --version | head -n 1

        echo "=== Checking snakemake ==="
        snakemake --version

    - name: Test config file
      shell: bash -el {0}
      run: |
        python3 -c "
        import yaml
        with open('config.yaml', 'r') as f:
            config = yaml.safe_load(f)
        print('✓ Config file is valid YAML')
        print('  Max SDs:', config.get('max_sds'))
        print('  SD calls:', config.get('sd_calls'))
        "

    - name: Test SD filtering script
      shell: bash -el {0}
      run: |
        python3 -c "
        import sys
        import os

        # Mock snakemake object
        class Snakemake:
            class Input:
                sd_calls = 'data/sd_calls.tsv'
            class Output:
                filtered = 'results/test_filtered_sds.tsv'
                stats = 'results/test_filtering_stats.txt'
            class Params:
                max_sds = 5
                filter_opts = {'priority': 'genes', 'min_sd_size': 0}
                coord_system = 'contig'
            input = Input()
            output = Output()
            params = Params()

        snakemake = Snakemake()
        os.makedirs('results', exist_ok=True)

        exec(open('scripts/filter_sds.py').read())
        "

        echo "✓ Filtering script works!"
        head -n 3 results/test_filtered_sds.tsv

    - name: Test sequence extraction script
      shell: bash -el {0}
      run: |
        python3 -c "
        import sys
        import os

        # Mock snakemake object
        class Snakemake:
            class Input:
                filtered_sds = 'results/test_filtered_sds.tsv'
            class Output:
                sequence_dir = 'results/test_sequences'
                manifest = 'results/test_manifest.txt'
            class Params:
                assemblies = {
                    'assembly_dir': 'data/assemblies',
                    'assembly_pattern': '{sample}_{haplotype}.fasta'
                }
                reference = {'fasta': None}
                coord_system = 'contig'
            input = Input()
            output = Output()
            params = Params()

        snakemake = Snakemake()

        exec(open('scripts/extract_sequences.py').read())
        "

        echo "✓ Sequence extraction works!"
        ls -lh results/test_sequences/ | head -n 5

    - name: Test minimap2 alignment
      shell: bash -el {0}
      run: |
        mkdir -p results/test_alignments
        minimap2 -x asm20 -c --eqx --secondary=no \
          results/test_sequences/SD_00000_SD1.fa \
          results/test_sequences/SD_00000_SD2.fa \
          > results/test_alignments/SD_00000.paf 2>&1

        echo "✓ Minimap2 alignment works!"
        echo "Alignment has $(grep -v '^\\[' results/test_alignments/SD_00000.paf | wc -l) alignment records"

    - name: Test SVbyEye visualization
      run: |
        mkdir -p results/test_plots

        Rscript -e '
        library(SVbyEye)
        library(ggplot2)

        # Read PAF
        paf_file <- "results/test_alignments/SD_00000.paf"
        cat("Reading PAF file...\n")
        paf_table <- readPaf(paf.file = paf_file, include.paf.tags = TRUE, restrict.paf.tags = "cg")
        cat("Found", nrow(paf_table), "alignments\n")

        # Create plot
        cat("Creating plot...\n")
        plt <- plotMiro(paf.table = paf_table, color.by = "direction")
        plt <- plt + labs(title = "Test SD Visualization")

        # Save
        ggsave("results/test_plots/test_plot.png", plot = plt, width = 12, height = 8, dpi = 150)
        cat("✓ Plot saved!\n")
        '

        echo "✓ SVbyEye visualization works!"
        ls -lh results/test_plots/

    - name: Run full Snakemake pipeline (dry run)
      shell: bash -el {0}
      run: |
        snakemake --dry-run --cores 1

    - name: Run full Snakemake pipeline
      shell: bash -el {0}
      run: |
        snakemake --cores 2 --verbose

    - name: Verify pipeline outputs
      shell: bash -el {0}
      run: |
        echo "=== Checking outputs ==="

        echo "Filtered SDs:"
        [ -f "results/filtered_sds.tsv" ] && echo "✓ filtered_sds.tsv exists" || echo "✗ filtered_sds.tsv missing"

        echo "Sequences:"
        [ -d "results/sequences" ] && echo "✓ sequences/ exists" || echo "✗ sequences/ missing"
        ls results/sequences/*.fa 2>/dev/null | wc -l | xargs -I {} echo "  {} sequence files"

        echo "Alignments:"
        [ -d "results/alignments" ] && echo "✓ alignments/ exists" || echo "✗ alignments/ missing"
        ls results/alignments/*.paf 2>/dev/null | wc -l | xargs -I {} echo "  {} PAF files"

        echo "Plots:"
        [ -d "results/plots" ] && echo "✓ plots/ exists" || echo "✗ plots/ missing"
        ls results/plots/*.png 2>/dev/null | wc -l | xargs -I {} echo "  {} plot files"

        echo "Report:"
        [ -f "results/summary_report.html" ] && echo "✓ summary_report.html exists" || echo "✗ summary_report.html missing"

    - name: Upload pipeline results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pipeline-results
        path: |
          results/filtered_sds.tsv
          results/filtering_stats.txt
          results/plots/
          results/summary_report.html
          results/logs/
        retention-days: 7

    - name: Upload test plots
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-plots
        path: results/test_plots/
        retention-days: 7

    - name: Check for errors in logs
      if: always()
      shell: bash -el {0}
      run: |
        if [ -d "results/logs" ]; then
          echo "=== Checking for errors in logs ==="
          grep -i error results/logs/*.log 2>/dev/null || echo "No errors found in logs"
        fi

    - name: Pipeline summary
      if: always()
      shell: bash -el {0}
      run: |
        echo "=================================="
        echo "Pipeline Test Summary"
        echo "=================================="

        if [ -f "results/filtering_stats.txt" ]; then
          echo ""
          echo "=== Filtering Stats ==="
          cat results/filtering_stats.txt
        fi

        echo ""
        echo "=== Final File Count ==="
        echo "SD pairs filtered: $([ -f results/filtered_sds.tsv ] && tail -n +2 results/filtered_sds.tsv | wc -l || echo 0)"
        echo "Sequences extracted: $(ls results/sequences/*.fa 2>/dev/null | wc -l)"
        echo "Alignments created: $(ls results/alignments/*.paf 2>/dev/null | wc -l)"
        echo "Plots generated: $(ls results/plots/*.png 2>/dev/null | wc -l)"
        echo ""
        echo "=================================="
        echo "✓ Pipeline test complete!"
        echo "=================================="
