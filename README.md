# SVbyEye Pipeline

The SVbyEye pipeline automates the selection, alignment, and visualization of segmental duplication (SD) pairs using the [SVbyEye](https://github.com/daewoooo/SVbyEye) R package. It is designed for comparative genomics teams that require reproducible, well-documented summaries of SD structure across assemblies and reference genomes.

## Key Capabilities

- Filters candidate SD pairs according to configurable criteria such as size, gene content, and coordinate system availability.
- Extracts SD sequences from haplotype-resolved assemblies or reference genomes and records provenance in a manifest.
- Aligns SD pairs with minimap2 and renders publication-ready plots with SVbyEye.
- Produces an HTML report that consolidates summary statistics and plot artifacts for rapid review.
- Provides an end-to-end Snakemake workflow with checkpoints, logging, and automated testing hooks.

## Requirements

- **Operating system:** Linux or macOS.
- **Core tools:** [Snakemake](https://snakemake.readthedocs.io/), [minimap2](https://github.com/lh3/minimap2), [samtools](http://www.htslib.org/doc/samtools.html), Python ≥3.9, and R ≥4.2 with the SVbyEye dependencies.
- **Optional:** `pysam` (used as a fallback if `samtools` is not installed), `conda` or `mamba` for environment management.

The `setup.sh` script and the `install_svbyeye*.R` helpers provide reference installation steps for common environments.

## Getting Started

1. **Clone the repository** and create a dedicated environment containing Snakemake, minimap2, samtools, pandas, and R with SVbyEye.
2. **Prepare input data**
   - Place a tab-delimited SD callset at `data/sd_calls.tsv`. The table must include at least `Sample`, `Haplotype`, `SD1_original`, and `SD2_original`. Optional columns such as `SD*_T2T`, `SD*_has_exon`, and `Gene_names` enable additional filtering and annotation.
   - Store assembly FASTA files in `data/assemblies/` (or update the configuration to match your layout).
   - Provide a reference FASTA if T2T coordinates will be used.
3. **Configure the analysis** by editing `config.yaml`. At minimum update `sd_calls`, adjust `assemblies` to match your directory structure, and review filtering and alignment parameters.
4. **Dry-run the workflow** to verify rule resolution:
   ```bash
   snakemake -n
   ```
5. **Execute the pipeline** once the configuration is validated:
   ```bash
   snakemake --cores 4
   ```
6. **Review the outputs** in the directory specified by `output_dir` (default: `results/`). Key artifacts include:
   - `filtered_sds.tsv`: prioritized SD list with derived metrics.
   - `sequence_manifest.txt`: provenance for extracted FASTA segments.
   - `alignments/*.paf`: pairwise alignments for each SD pair.
   - `plots/*.png` (and optionally `.pdf`): visual summaries generated by SVbyEye.
   - `summary_report.html`: consolidated statistics and figures.

## Configuration Overview

`config.yaml` governs pipeline behavior. Important sections include:

- **Input definition:** `sd_calls`, `assemblies`, and `reference` declare the data sources used throughout the workflow.
- **Filtering:** `filter` controls SD selection heuristics (priority ordering, minimum size thresholds, and sample/haplotype restrictions).
- **Coordinate system:** `coordinate_system` chooses between contig coordinates, T2T coordinates, or an automatic preference order.
- **Alignment parameters:** `minimap2` settings (preset, additional flags) are forwarded to minimap2.
- **Visualization:** `svbyeye` options configure binning, highlighting, and output format. `add_gene_annotations` toggles support for future gene overlays.
- **Execution resources:** `threads` and `memory` dictionaries specify resource hints for Snakemake rules.

All configuration options are documented inline within `config.yaml` for ease of maintenance.

## Workflow Summary

The Snakefile orchestrates the following stages:

1. **Filtering (`filter_sds`)** – derives summary metrics, applies filters, and prioritizes SD pairs.
2. **Sequence extraction (`extract_all_sequences`)** – retrieves FASTA segments based on the chosen coordinate system and records provenance.
3. **Alignment (`align_sd_pair`)** – aligns SD pairs using minimap2 presets suitable for high-identity comparisons.
4. **Visualization (`visualize_sd`)** – creates SVbyEye plots for each aligned pair.
5. **Reporting (`generate_report`)** – collates metadata and plots into an HTML summary.

Auxiliary rules support data cleanup, configuration checks, and collection of generated plots.

## Testing and Continuous Integration

A GitHub Actions workflow (`.github/workflows/test-pipeline.yml`) demonstrates how to run the pipeline in a continuous integration context. Triggering the workflow executes the full Snakemake pipeline on bundled test data and uploads the resulting artifacts. Adapt the workflow to mirror your production environment or to validate changes before deployment.

## Contributing

- Follow the code style documented in the repository (PEP 8 for Python, tidyverse style for R) and keep comments concise, descriptive, and oriented toward scientific interpretation.
- Update tests and documentation when modifying workflow logic or configuration interfaces.
- Use descriptive commit messages and Pull Request descriptions that summarize both functional changes and scientific context.

## Support

For questions about SVbyEye plotting semantics, consult the upstream [SVbyEye documentation](https://github.com/daewoooo/SVbyEye). Issues specific to this pipeline can be raised via the repository issue tracker.
